<h2 id="local-zip-requireminizip2"><code>local zip = require'minizip2'</code></h2>
<p>A ffi binding of minizip2, a C library for creating and extracting zip archives, featuring:</p>
<ul>
<li>reading and writing zip archives from memory.</li>
<li>password protection with AES encryption.</li>
<li>preserving file attributes and timestamps across file systems.</li>
<li>multi-file archives.</li>
<li>following and storing symbolic links.</li>
<li>utf8 filename support.</li>
<li>zipping of central directory to reduce size.</li>
<li>generate and verify CMS file signatures.</li>
<li>recover the central directory if it is corrupt or missing.</li>
</ul>
<h2 id="api">API</h2>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>zip.open(opt | file,[mode],[passwd]) -&gt; rz|wz</code></td>
<td style="text-align: left;">open a zip file</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:entries() -&gt; iter() -&gt; e</code></td>
<td style="text-align: left;">iterate entries</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:first() -&gt; true|false</code></td>
<td style="text-align: left;">goto first entry</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:next() -&gt; true|false</code></td>
<td style="text-align: left;">goto next entry</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:find(filename[, ignore_case]) -&gt; true|false</code></td>
<td style="text-align: left;">find entry</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz.entry_is_dir -&gt; true|false</code></td>
<td style="text-align: left;">is current entry a directory?</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:entry_hash(['md5'|'sha1'|'sha256']) -&gt; s|false</code></td>
<td style="text-align: left;">current entry hash</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz.sign_required = true|false</code></td>
<td style="text-align: left;">require signing</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz.file_has_sign -&gt; true|false</code></td>
<td style="text-align: left;">is <em>opened <em>file</em> entry</em> signed?</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:file_verify_sign() -&gt; true|false</code></td>
<td style="text-align: left;">verify signature of <em>opened file entry</em></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz.entry -&gt; e</code></td>
<td style="text-align: left;">get current entry info</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.compression_method -&gt; s</code></td>
<td style="text-align: left;">compression method</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.mtime -&gt; ts</code></td>
<td style="text-align: left;">last modified time</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.atime -&gt; ts</code></td>
<td style="text-align: left;">last accessed time</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.btime -&gt; ts</code></td>
<td style="text-align: left;">creation time</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.crc -&gt; n</code></td>
<td style="text-align: left;">crc-32</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.compressed_size -&gt; n</code></td>
<td style="text-align: left;">compressed size</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.uncompressed_size -&gt; n</code></td>
<td style="text-align: left;">uncompressed size</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.disk_number -&gt; n</code></td>
<td style="text-align: left;">disk number start</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.disk_offset -&gt; n</code></td>
<td style="text-align: left;">relative offset of local header</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.internal_fa -&gt; n</code></td>
<td style="text-align: left;">internal file attributes</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.external_fa -&gt; n</code></td>
<td style="text-align: left;">external file attributes</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.filename -&gt; s</code></td>
<td style="text-align: left;">filename</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.comment -&gt; s</code></td>
<td style="text-align: left;">comment</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.linkname -&gt; s</code></td>
<td style="text-align: left;">sym-link filename</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.zip64 -&gt; true|false</code></td>
<td style="text-align: left;">zip64 extension mode</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>e.aes_version -&gt; n</code></td>
<td style="text-align: left;">winzip aes extension if not 0</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>e.aes_encryption_mode -&gt; n</code></td>
<td style="text-align: left;">winzip aes encryption mode</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:extract(to_filepath)</code></td>
<td style="text-align: left;">extract current entry to file</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:extract_all(to_dir)</code></td>
<td style="text-align: left;">extract all to dir</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:read'*a' -&gt; s</code></td>
<td style="text-align: left;">read entire entry as string</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:open_entry()</code></td>
<td style="text-align: left;">open current entry</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz:read(buf, maxlen) -&gt; len</code></td>
<td style="text-align: left;">read from opened entry into a buffer</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz:close_entry()</code></td>
<td style="text-align: left;">close entry</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz.pattern = s</code></td>
<td style="text-align: left;">filter listing entries</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz.ci_pattern = s</code></td>
<td style="text-align: left;">filter listing entries (case insensitive)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz|wz.password = s</code></td>
<td style="text-align: left;">set password for decryption/encryption</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz|wz.raw = true|false</code></td>
<td style="text-align: left;">set raw mode</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz|wz.raw -&gt; true|false</code></td>
<td style="text-align: left;">get raw mode</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz.encoding = 'utf8'|codepage</code></td>
<td style="text-align: left;">support codepages in filenames</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz.zip_cd -&gt; true|false</code></td>
<td style="text-align: left;">does the zip have a zipped central directory?</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz.zip_cd = true|false</code></td>
<td style="text-align: left;">zip the central directory</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz.comment -&gt; s</code></td>
<td style="text-align: left;">get comment for the central directory</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz.aes = true|false</code></td>
<td style="text-align: left;">use aes encryption</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>wz.store_links = true|false</code></td>
<td style="text-align: left;">store symlinks</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz.follow_links = true|false</code></td>
<td style="text-align: left;">follow symlinks</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>wz.compression_level = 0..9</code></td>
<td style="text-align: left;">set compression level</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz.compression_method = 'store|deflate'</code></td>
<td style="text-align: left;">set compression method</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>wz:add_file(filepath[, filepath_in_zip])</code></td>
<td style="text-align: left;">archive a file</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz:add_memfile{filename=,data=,[size=],...}</code></td>
<td style="text-align: left;">add a file from a memory buffer</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>wz:add_all(dir,[root_dir],[incl_path],[recursive])</code></td>
<td style="text-align: left;">add entire dir</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz:add_all_from_zip(rz)</code></td>
<td style="text-align: left;">add all entries from other zip file</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>wz:zip_cd()</code></td>
<td style="text-align: left;">compress central directory</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>wz:set_cert(cert_path[, password])</code></td>
<td style="text-align: left;">set signing certificate</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>rz|wz.zip_handle -&gt; z</code></td>
<td style="text-align: left;">get C zip handle</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rz|wz:close()</code></td>
<td style="text-align: left;">close the zip file</td>
</tr>
</tbody>
</table>
<p><strong>NOTE:</strong> All functions raise on errors, with the exception of I/O and parsing errors on which they return <code>nil, err, errcode</code>.</p>
<h3 id="zip.openoptions-filemodepasswd---rzwz"><code>zip.open(options | file,[mode],[passwd]) -&gt; rz|wz</code></h3>
<p>The options table has the fields:</p>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>key</strong></td>
<td><strong>mode</strong></td>
<td style="text-align: left;"><strong>value</strong></td>
<td style="text-align: left;"><strong>default</strong></td>
<td style="text-align: left;"><strong>meaning</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>mode</code></td>
<td>rwa</td>
<td style="text-align: left;"><code>'r'|'w'|'a'</code></td>
<td style="text-align: left;"><code>'r'</code></td>
<td style="text-align: left;">open for reading, writing or appending</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>file</code></td>
<td>rwa</td>
<td style="text-align: left;"><code>string</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">open a zip file from disk</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>in_memory</code></td>
<td>r</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">load whole file in memory</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>data</code></td>
<td>r</td>
<td style="text-align: left;"><code>string|buffer</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">open a zip file from a memory buffer or string</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>size</code></td>
<td>r</td>
<td style="text-align: left;"><code>number</code></td>
<td style="text-align: left;"><code>#data</code></td>
<td style="text-align: left;">data size</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>copy</code></td>
<td>r</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">copy the buffer before loading</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>pattern</code></td>
<td>r</td>
<td style="text-align: left;"><code>string</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">filter listing entries</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ci_pattern</code></td>
<td>r</td>
<td style="text-align: left;"><code>string</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">filter listing entries (case insensitive)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>password</code></td>
<td>rwa</td>
<td style="text-align: left;"><code>string</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">set password for decryption/encryption</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>raw</code></td>
<td>rwa</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">set raw mode</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>encoding</code></td>
<td>r</td>
<td style="text-align: left;"><code>'utf8'|codepage</code></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">support codepages in filenames</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>zip_cd</code></td>
<td>w</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">zip the central directory</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>aes</code></td>
<td>w</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>true</code> (!)</td>
<td style="text-align: left;">use aes encryption</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>store_links</code></td>
<td>w</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">store symlinks</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>follow_links</code></td>
<td>w</td>
<td style="text-align: left;"><code>true|false</code></td>
<td style="text-align: left;"><code>false</code></td>
<td style="text-align: left;">follow symlinks</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>compression_level</code></td>
<td>w</td>
<td style="text-align: left;"><code>0..9</code></td>
<td style="text-align: left;"><code>9</code></td>
<td style="text-align: left;">compression level</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>compression_method</code></td>
<td>w</td>
<td style="text-align: left;"><code>'store|deflate'</code></td>
<td style="text-align: left;"><code>'deflate'</code></td>
<td style="text-align: left;">compression method</td>
</tr>
</tbody>
</table>
<p>Open a zip file for reading, writing or appending. The zip file bits can come from the filesystem or from a memory buffer.</p>
<h2 id="notes">Notes</h2>
<p>Neither Windows Explorer on Windows 10 nor Total Commander can read zip files with zipped central directory (<code>zip_cd</code> option).</p>
<p>Windows Explorer on Windows 10 cannot read AES-encrypted zip entries (<code>aes</code> option, enabled by default). On the other hand, the old PKZIP encryption (<code>aes = false</code>) is not secure at all, and can be decrypted with specialized tools since 1990 regardless of password length. So you have to choose between security and accessibility with this one as you canâ€™t have both.</p>
<p>AES encryption (<code>aes</code> option) encrypts with AES-256, the only bit length available.</p>
<h2 id="binaries">Binaries</h2>
<p>The included binaries only support deflate compression for which they depend on zlib. LZMA and bzip2 compression/decompression is not supported in the binary (the binding supports it though if you have the right binary).</p>
<h2 id="todo">TODO</h2>
<ul>
<li>stream API (yieldable if possible)</li>
</ul>
